import{r as b,j as t,L as M,u as z,H as _}from"./app-COq-72Cj.js";import{u as D,A as V}from"./app-layout-D5tCa-VZ.js";import{C as W,a as G,b as H,c as K,d as q}from"./card-Cwwb2SH3.js";import{B as I}from"./button-D_MDrT2V.js";import{S as v,T as J,A as Z}from"./trash-2-bUCYv1YA.js";import{z as Q}from"./transition-vGFZFePg.js";import{F as X}from"./form-fields-DWwHz2Ai.js";function Y({view:u,data:s,setData:e}){const a=b.useRef(!1);b.useEffect(()=>{if(u!=="liquidacion")return;const p=parseFloat(s.valor??"");let d=parseFloat(s.porcentaje??"");parseInt(s.id_tipo_liquid)===1&&parseInt(s.nrorev)===1&&(d*=4);const h=d/100,m=parseFloat(s.tasamin??""),c=parseFloat(s.tasamax??""),r=parseFloat(s.igv??"");if(!(!isNaN(p)&&!isNaN(h))){e("porcenaplica",""),e("igvporcen",""),e("subtotal",""),e("total","");return}const n=p*h;e("porcenaplica",n.toFixed(2));const f=isNaN(r)?0:n/100*r;e("igvporcen",f.toFixed(2));const x=n+f;e("subtotal",x.toFixed(2));let i=x;isNaN(m)||(i=Math.max(i,m)),!isNaN(c)&&c>0&&(i=Math.min(i,c)),e("total",i.toFixed(2)),a.current=!0},[u,s.valor,s.porcentaje,s.igv,s.tasamin,s.tasamax,s.id_tipo_liquid,s.nrorev])}function ee(u,s,e,a,p){if(!u?.values?.length)return{activeOption:"",hiddenFields:[],ToggleUI:()=>null};const{label:d,values:h,fields:m}=u,c=p==="info"||p==="delete",r=b.useCallback(()=>h.find(l=>(m[l]||[]).some(j=>e[j]!=null&&e[j]!==""))||h[0],[e,m,h]),[o,n]=b.useState(()=>r()),[f,x]=b.useState(!1),i=b.useCallback(l=>{if(a==="tasaliquid")return;const j=new Set(m[l]||[]);Object.values(m).flat().forEach(F=>{j.has(F)||s(F,"")})},[m,s,a]);b.useEffect(()=>{if(f)return;const l=r();l!==o&&(n(l),i(l))},[e,f,o,r,i]);const g=b.useCallback(l=>{l!==o&&(x(!0),n(l),i(l))},[o,i]),N=b.useMemo(()=>{const l=new Set(m[o]||[]);return Object.values(m).flat().filter(j=>!l.has(j))},[m,o]);return{activeOption:o,hiddenFields:N,ToggleUI:()=>t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs("span",{className:"text-sm font-medium",children:[d,":"]}),h.map(l=>t.jsx(I,{type:"button",variant:o===l?"default":"outline",onClick:()=>g(l),disabled:c,children:l},l))]})}}const te={create:{formAction:"store",method:"POST",buttonText:"Registrar",buttonClass:"bg-blue-500 hover:bg-blue-600 text-white",buttonIcon:t.jsx(v,{className:"mr-2 h-4 w-4"}),description:"Ingresa los datos cuidadosamente.",titlePrefix:"REGISTRO DE"},update:{formAction:"update",method:"PUT",buttonText:"Actualizar",buttonClass:"bg-green-600 hover:bg-green-500 text-white",buttonIcon:t.jsx(v,{className:"mr-2 h-4 w-4"}),description:"Actualiza los datos con cuidado.",titlePrefix:"ACTUALIZAR"},delete:{formAction:"destroy",method:"DELETE",buttonText:"Eliminar",buttonClass:"bg-red-700 hover:bg-red-800 text-white destructive",buttonIcon:t.jsx(J,{className:"mr-2 h-4 w-4"}),description:"¿Estás seguro que deseas eliminar? Esta acción es irreversible.",titlePrefix:"ELIMINAR",readonly:!0},info:{formAction:"info",method:"POST",buttonText:"",buttonClass:"bg-gray-500 hover:bg-gray-600 text-white",buttonIcon:t.jsx(v,{className:"mr-2 h-4 w-4"}),description:"Consulta la información.",titlePrefix:"INFORMACIÓN DE",readonly:!0}},se=(u,s,e)=>u[`id_${s}`]??(s==="itemsimple"&&e?.tipo?u[`id_${e.tipo}`]:void 0),ne=(u,s,e,a,p,d,h,m,c,r)=>b.useMemo(()=>{const o=u||"create",n=te[o],f=se(e,a,r);let x=s;(x.endsWith("s")||x.endsWith("S"))&&(x=x.slice(0,-1));const i=`${n.titlePrefix} ${x.toUpperCase()}`,g=o==="delete",N=typeof r=="string"?`?tipo=${r}`:r?`?${new URLSearchParams(Object.entries(r).map(([y,F])=>[y,String(F)])).toString()}`:"",T=y=>{switch(y.preventDefault(),n.method){case"POST":p(route(`${a}.${n.formAction}`));break;case"PUT":f&&d(route(`${a}.${n.formAction}`,f));break;case"DELETE":f&&h(route(`${a}.${n.formAction}`,f));break}},l=()=>n.buttonText?t.jsxs(I,{type:"submit",disabled:m,className:n.buttonClass,children:[n.buttonIcon,n.buttonText]}):null,j=t.jsxs("div",{className:"flex items-center justify-between mt-4",children:[t.jsx(M,{href:`/${a}${N}`,children:t.jsxs(I,{size:"sm",variant:"outline",children:[t.jsx(Z,{className:"mr-2 h-4 w-4"})," Regresar"]})}),t.jsxs("div",{className:"flex items-center gap-x-4",children:[t.jsx(Q,{show:c,enter:"transition ease-in-out",enterFrom:"opacity-0",leave:"transition ease-in-out",leaveTo:"opacity-0",children:t.jsx("p",{className:`text-sm ${g?"text-red-600":"text-neutral-600"} dark:text-neutral-400`,children:"Guardado"})}),t.jsx(l,{})]})]});return{config:n,title:i,isDestructive:g,description:n.description,readonly:n.readonly||!1,handleSubmit:T,FooterButtons:j,formDataId:f}},[u,s,e,a,p,d,h,m,c,r]);function oe({data:u,setData:s,apiConfig:e,view:a}){if(!e)return null;const p=b.useRef(null),d=async()=>{const c=u[e.inputKey]?.trim();if(!c)return alert("El campo no puede estar vacío");try{const o=await(await fetch(`undefined/${e.endpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({[e.inputKey]:c})})).json();console.log(`[${a}] Respuesta API texto:`,o),Object.entries(e.fields).forEach(([n,f])=>s(n,o[f]??e.emptyValue))}catch(r){console.error(`[${a}]`,r),Object.keys(e.fields).forEach(o=>s(o,e.emptyValue))}},h=async c=>{if(!c)return;const r=new FormData;r.append("imagen",c);try{const n=await(await fetch(`undefined/${e.endpoint}`,{method:"POST",body:r})).json();console.log(`[${a}] Respuesta API imagen:`,n),Object.entries(e.fields).forEach(([f,x])=>s(f,n[x]??e.emptyValue))}catch(o){console.error(`[${a}]`,o),Object.keys(e.fields).forEach(n=>s(n,e.emptyValue))}};return({fieldKey:c})=>c!==e.inputKey?null:e.type==="file"?t.jsxs(t.Fragment,{children:[t.jsx("input",{type:"file",ref:p,className:"hidden",accept:"image/*",onChange:r=>{const o=r.target.files?.[0];o&&h(o)}}),t.jsx("button",{type:"button",className:"px-2 py-1 bg-blue-200 rounded hover:bg-blue-300 ml-1",onClick:()=>p.current?.click(),children:"📂 Buscar imagen"})]}):e.type==="text"?t.jsx("button",{type:"button",className:"px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 ml-1",onClick:d,children:"🔍"}):null}const me=({form_data:u,formFields:s,sheetFields:e,action:a,custom_title:p,view:d,title:h,width_form:m="w-full",readonly:c=!1,toggleOptions:r,queryparams:o,apiConfig:n,submitForm:f,debug:x=!1})=>{const{data:i,setData:g,post:N,put:T,delete:l,processing:j,errors:y,recentlySuccessful:F}=z(u),S=b.useRef({}),A=D();Y({view:d,data:i,setData:g});const{title:O,description:R,borderColor:P,readonly:C,handleSubmit:k,FooterButtons:B}=ne(a,p,u,d,N,T,l,j,F,o),{hiddenFields:L,ToggleUI:$}=ee(r,g,i,d,a),U=oe({data:i,setData:g,apiConfig:n,view:d}),w=E=>{E.preventDefault(),x&&console.log("📤 Datos que se enviarán:",i),k(E)};return t.jsxs(V,{breadcrumbs:[{title:h,href:d}],children:[t.jsx(_,{title:h}),t.jsx("div",{className:"flex flex-1 flex-col gap-4 p-4 rounded-xl",children:t.jsxs(W,{className:`${A?"w-full":m} border-2 ${P}`,children:[t.jsx(G,{children:t.jsxs("div",{className:"flex flex-wrap items-start gap-x-4",children:[t.jsxs("div",{children:[t.jsx(H,{children:O}),t.jsx(K,{children:R})]}),$&&t.jsx("div",{className:"mt-1",children:t.jsx($,{})})]})}),t.jsx(q,{children:t.jsxs("form",{onSubmit:f??w,action:route(`${d}.form`,{id:u?.id,action:a}),method:"POST",className:"space-y-2",encType:"multipart/form-data",children:[t.jsx("div",{className:"flex flex-wrap gap-4",children:t.jsx(X,{formFields:s,data:i,setData:g,errors:y,readonly:c||C,hiddenFields:L,isMobile:A,inputRefs:S,view:d,apiConfig:n,FetchButton:U})}),B]})})]})})]})};export{me as F};
