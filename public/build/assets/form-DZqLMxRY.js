import{j as e,r as d,u as P,H as K}from"./app-JCqQpdZA.js";import{D as Z,j as q,k as J,l as Q,m as X,A as Y}from"./app-layout-B06hwOrM.js";import{C as ee,a as te,b as se,c as ae,d as oe}from"./card-BT-kMm54.js";import{u as re}from"./sidebar_cita-CKX3SdKM.js";import{u as ie,a as le,b as ne,c as ce}from"./use-fetch-with-button-eHSQixcs.js";import{F as G}from"./form-fields-Blb7kzuA.js";import{c as de,b as pe,B as I}from"./button-D-2R9ziQ.js";import{P as H}from"./pencil-CgB1-RjR.js";import{T as U}from"./trash-Dr08xz_C.js";import{L as ue}from"./loader-circle-B06CUjlb.js";import{S as me}from"./trash-2-DeW0HUD3.js";/* empty css            */import"./index-B9f0Ug1v.js";import"./index-CST4R46g.js";import"./check-s2lTzm8J.js";import"./index-CVASjcgI.js";import"./transition-DtuZMdcZ.js";import"./input-CQ-ihBpF.js";import"./label-BDPI_18D.js";import"./input-error-t6Y2H9Yc.js";import"./search-DmclBCC0.js";const fe=pe("flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",{variants:{orientation:{horizontal:"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none",vertical:"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none"}},defaultVariants:{orientation:"horizontal"}});function he({className:a,orientation:i,...n}){return e.jsx("div",{role:"group","data-slot":"button-group","data-orientation":i,className:de(fe({orientation:i}),a),...n})}const $={seguimientos:"SEGUIMIENTO",procedimientos:"PROCEDIMIENTO",medicamentos:"MEDICAMENTO",anamnesis:"ANAMNESIS"},xe={create:{title:"REGISTRAR",btn:"Guardar",cls:"bg-blue-600 hover:bg-blue-700 text-white",icon:e.jsx(me,{className:"w-4 h-4"}),border:"border-l border-blue-500"},update:{title:"ACTUALIZAR",btn:"Actualizar",cls:"bg-green-600 hover:bg-green-700 text-white",icon:e.jsx(H,{className:"w-4 h-4"}),border:"border-l border-green-500"},delete:{title:"ELIMINAR",btn:"Eliminar",cls:"bg-red-600 hover:bg-red-700 text-white",icon:e.jsx(U,{className:"w-4 h-4"}),border:"border-l border-red-500",readonly:!0}},k=a=>a.endsWith("is")?a:a.replace(/s$/,""),z=a=>`id_historia_clinica_${k(a)}`,L=(a,i)=>i?`/historia_clinica_${k(a)}/${i}`:`/historia_clinica_${k(a)}/form`,B=(a,i)=>a.find(n=>n.key.startsWith("id_")||n.label.toLowerCase().includes(k(i)))?.value??null,be=a=>a.charAt(0).toUpperCase()+a.slice(1).toLowerCase(),O=a=>{if(!a||!/^\d{4}-\d{2}-\d{2}$/.test(a))return null;const[i,n,x]=a.split("-").map(Number);return new Date(i,n-1,x)},ge=a=>{if(!a)return"Sin fecha";const i=O(a);return i?i.toLocaleDateString("es-PE"):"Sin fecha"};function je({view:a,formId:i,action:n="update"}){const x=n==="update",c=d.useMemo(()=>window.location.pathname.match(/\/update\/(\d+)/)?.[1]??i,[i]),[s,j]=d.useState({open:!1,tipo:null,reg:null,act:"update"}),[m,A]=d.useState({}),[u,N]=d.useState({}),[y,f]=d.useState({}),h=d.useRef({}),{post:v,put:D,delete:F,processing:S,errors:T,setData:w}=P({}),b=d.useCallback(()=>{fetch(`/api/historia/${c}/records`).then(t=>t.json()).then(f).catch(()=>{})},[c]);d.useEffect(b,[b]),d.useEffect(()=>{!s.open||!s.tipo||m[s.tipo]||fetch(`/api/historia/${s.tipo}/fields`).then(t=>t.json()).then(t=>A(o=>({...o,[s.tipo]:Object.entries(t).map(([r,l])=>[r,l.label??r,l.type??"text",l.options??null])})))},[s.open,s.tipo,m]),d.useEffect(()=>{if(!s.open||!s.tipo||!m[s.tipo])return;const t={};m[s.tipo].forEach(([r])=>t[r]=s.reg?.find(l=>l.key===r)?.value??"");const o=s.reg?B(s.reg,s.tipo):null;o&&(t[z(s.tipo)]=o),s.act==="create"&&(t.id_historia_clinica=c),N(t)},[s.open,s.tipo,s.reg,m,c]),d.useEffect(()=>w(u),[u,w]);const R=d.useCallback(t=>{if(t.preventDefault(),!s.tipo)return;const o=u[z(s.tipo)],l={onSuccess:()=>{j(C=>({...C,open:!1})),b()}};s.act==="create"?v(L(s.tipo),{data:u,...l}):s.act==="update"?D(L(s.tipo,o),{data:u,...l}):F(L(s.tipo,o),l)},[s,u,v,D,F,b]),g=(t,o,r)=>j({open:!0,tipo:t,reg:o,act:r}),_=()=>j({open:!1,tipo:null,reg:null,act:"update"}),M=d.useMemo(()=>Object.entries(y).flatMap(([t,o])=>o.map(r=>({k:t,tipo:$[t],f:r,fecha:r.find(l=>l.key==="fecha")?.value??null,id:B(r,t)}))).sort((t,o)=>{const r=t.fecha?+O(t.fecha):0;return(o.fecha?+O(o.fecha):0)-r}),[y]),p=s.tipo?xe[s.act]:null,E=s.tipo?$[s.tipo]:"";return e.jsxs("div",{className:"flex flex-col gap-4",children:[x&&e.jsx(he,{className:"gap-1 flex flex-wrap",children:Object.keys($).map(t=>e.jsx(I,{size:"sm",variant:"outline",className:"text-xs font-medium min-w-0 px-2",onClick:()=>g(t,null,"create"),children:be($[t])},t))}),M.map(t=>e.jsxs("div",{className:"border rounded-lg p-3 flex justify-between bg-muted/40",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-purple-600 dark:text-purple-400",children:[t.tipo,t.fecha?e.jsxs("span",{className:"ml-2 text-purple-600 dark:text-purple-400",children:["â€” ",ge(t.fecha)]}):e.jsx("span",{className:"ml-2 text-gray-400 dark:text-gray-500",children:"â€” Sin fecha"})]}),t.f.filter(o=>!["id_","fecha","created_at","updated_at"].some(r=>o.key.startsWith(r)||o.key===r)).map((o,r)=>e.jsxs("p",{className:"text-sm",children:[o.label,": ",o.value??"-"]},r))]}),x&&e.jsxs("div",{className:"flex flex-col gap-1 ml-2",children:[e.jsx(I,{size:"icon",variant:"outline",onClick:()=>g(t.k,t.f,"update"),children:e.jsx(H,{className:"w-4 h-4"})}),e.jsx(I,{size:"icon",variant:"destructive",onClick:()=>g(t.k,t.f,"delete"),children:e.jsx(U,{className:"w-4 h-4"})})]})]},`${t.k}-${t.id}`)),e.jsx(Z,{open:s.open,onOpenChange:_,children:e.jsxs(q,{className:`max-w-lg p-6 ${p?.border||""}`,children:[p&&e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsxs(Q,{className:"flex items-center gap-2 text-lg font-bold",children:[p.title," ",E]})}),e.jsxs(X,{className:"sr-only",children:["Formulario para ",p.title.toLowerCase()," ",E.toLowerCase(),"."]})]}),e.jsxs("form",{onSubmit:R,className:"space-y-3",children:[(m[s.tipo??""]??[]).filter(([t])=>t!=="id_historia_clinica").map(([t,o,r,l])=>e.jsx(G,{formFields:{[t]:{form:{key:t,label:o,type:r,options:l}}},data:u,setData:(C,W)=>N(V=>({...V,[C]:W})),errors:T,readonly:p?.readonly,hiddenFields:[],isMobile:!0,inputRefs:h,view:a},t)),e.jsx("div",{className:"flex justify-end",children:e.jsxs(I,{type:"submit",disabled:S,className:`${p?.cls} flex items-center gap-2`,children:[S?e.jsx(ue,{className:"w-4 h-4 animate-spin"}):p?.icon,p?.btn]})})]})]})})]})}const Ne=({form_data:a,formFields:i,action:n,custom_title:x,view:c,title:s,width_form:j="w-full",readonly:m=!1,toggleOptions:A,queryparams:u,apiConfig:N,debug:y=!1})=>{const{data:f,setData:h,post:v,put:D,delete:F,processing:S,errors:T,recentlySuccessful:w,reset:b}=P(a),R=d.useRef({}),g=re();ie({view:c,data:f,setData:h});const{title:_,description:M,cardBorderClass:p,readonly:E,handleSubmit:t,FooterButtons:o}=le(n,x,a,c,v,D,F,S,w,u,f,h,b),{hiddenFields:r,ToggleUI:l}=ne(A,h,f,c,n),C=ce({data:f,setData:h,apiConfig:N,view:c});return e.jsxs(Y,{breadcrumbs:[{title:s,href:c}],children:[e.jsx(K,{title:s}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 rounded-xl",children:[e.jsxs(ee,{className:`${g?"w-full":j} border-2 ${p}`,children:[e.jsx(te,{children:e.jsxs("div",{className:"flex flex-wrap items-start gap-x-4",children:[e.jsxs("div",{children:[e.jsx(se,{children:_}),e.jsx(ae,{children:M})]}),l&&e.jsx("div",{className:"mt-1",children:e.jsx(l,{})})]})}),e.jsxs(oe,{children:[y&&e.jsxs(e.Fragment,{children:[console.log("ðŸ“‹ formFields:",i),console.log("ðŸ“¤ data actual:",f)]}),e.jsxs("form",{onSubmit:t,action:route(`${c}.form`,{id:a?.id,action:n}),method:"POST",className:"space-y-2",encType:"multipart/form-data",children:[e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(G,{formFields:i,data:f,setData:h,errors:T,readonly:m||E,hiddenFields:r,isMobile:g,inputRefs:R,view:c,apiConfig:N,FetchButton:C})}),o]})]})]}),n!=="create"&&e.jsx(je,{view:c,action:n,formId:a?.[`id_${c}`],debug:y})]})]})};function Ge(a){return e.jsx(Ne,{...a})}export{Ge as default};
