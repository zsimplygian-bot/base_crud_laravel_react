import{r as d,j as e,u as z,H}from"./app-CWw-a1tk.js";import{u as K,A as W}from"./app-layout-BRIMJtDq.js";import{C as J,a as Z,b as Q,d as X,e as Y}from"./card-CtHjv_o2.js";import{B as w,c as ee,d as te}from"./button-uC_BeCuX.js";import{u as se}from"./use-form-action-DqtiBFFr.js";import{F as U,g as oe}from"./custom-titles-rHLuccQj.js";import{D as ne,a as re,b as ae,c as le,d as ie}from"./dialog-CCJIlJWn.js";import{P as G}from"./pencil-CRUsUFWx.js";import{T as V}from"./trash-CVDa9COs.js";import{L as ce}from"./loader-circle-CAguilvL.js";import{S as de}from"./trash-2-B_jHPywY.js";/* empty css            */import"./index-D-ZWCHxV.js";import"./sidebar_cita-DZVecSTe.js";import"./index-CusNlWmL.js";import"./index-CVASjcgI.js";import"./transition-cqGMUTSS.js";import"./label-DuO8iQ0C.js";import"./input-B3wL4Wl2.js";import"./field-combobox-CT4ZBcBP.js";import"./input-error-D4A83_zx.js";function ue({view:n,data:o,setData:t}){const j=d.useRef(!1);d.useEffect(()=>{if(n!=="liquidacion")return;const l=parseFloat(o.valor??"");let s=parseFloat(o.porcentaje??"");parseInt(o.id_tipo_liquid)===1&&parseInt(o.nrorev)===1&&(s*=4);const y=s/100,p=parseFloat(o.tasamin??""),b=parseFloat(o.tasamax??""),i=parseFloat(o.igv??"");if(!(!isNaN(l)&&!isNaN(y))){t("porcenaplica",""),t("igvporcen",""),t("subtotal",""),t("total","");return}const h=l*y;t("porcenaplica",h.toFixed(2));const x=isNaN(i)?0:h/100*i;t("igvporcen",x.toFixed(2));const v=h+x;t("subtotal",v.toFixed(2));let N=v;isNaN(p)||(N=Math.max(N,p)),!isNaN(b)&&b>0&&(N=Math.min(N,b)),t("total",N.toFixed(2)),j.current=!0},[n,o.valor,o.porcentaje,o.igv,o.tasamin,o.tasamax,o.id_tipo_liquid,o.nrorev])}function pe(n,o,t,j,l){if(!n?.values?.length)return{activeOption:"",hiddenFields:[],ToggleUI:()=>null};const{label:s,values:y,fields:p}=n,b=l==="info"||l==="delete",i=d.useCallback(()=>y.find(u=>(p[u]||[]).some(E=>t[E]!=null&&t[E]!==""))||y[0],[t,p,y]),[a,h]=d.useState(()=>i()),[x,v]=d.useState(!1),N=d.useCallback(u=>{if(j==="tasaliquid")return;const E=new Set(p[u]||[]);Object.values(p).flat().forEach($=>{E.has($)||o($,"")})},[p,o,j]);d.useEffect(()=>{if(x)return;const u=i();u!==a&&(h(u),N(u))},[t,x,a,i,N]);const I=d.useCallback(u=>{u!==a&&(v(!0),h(u),N(u))},[a,N]),T=d.useMemo(()=>{const u=new Set(p[a]||[]);return Object.values(p).flat().filter(E=>!u.has(E))},[p,a]);return{activeOption:a,hiddenFields:T,ToggleUI:()=>e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[s,":"]}),y.map(u=>e.jsx(w,{type:"button",variant:a===u?"default":"outline",onClick:()=>I(u),disabled:b,children:u},u))]})}}function me({data:n,setData:o,apiConfig:t,view:j}){if(!t)return null;const l=d.useRef(null),s=async()=>{const b=n[t.inputKey]?.trim();if(!b)return alert("El campo no puede estar vacÃ­o");try{const a=await(await fetch(`undefined/${t.endpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({[t.inputKey]:b})})).json();console.log(`[${j}] Respuesta API texto:`,a),Object.entries(t.fields).forEach(([h,x])=>o(h,a[x]??t.emptyValue))}catch(i){console.error(`[${j}]`,i),Object.keys(t.fields).forEach(a=>o(a,t.emptyValue))}},y=async b=>{if(!b)return;const i=new FormData;i.append("imagen",b);try{const h=await(await fetch(`undefined/${t.endpoint}`,{method:"POST",body:i})).json();console.log(`[${j}] Respuesta API imagen:`,h),Object.entries(t.fields).forEach(([x,v])=>o(x,h[v]??t.emptyValue))}catch(a){console.error(`[${j}]`,a),Object.keys(t.fields).forEach(h=>o(h,t.emptyValue))}};return({fieldKey:b})=>b!==t.inputKey?null:t.type==="file"?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",ref:l,className:"hidden",accept:"image/*",onChange:i=>{const a=i.target.files?.[0];a&&y(a)}}),e.jsx("button",{type:"button",className:"px-2 py-1 bg-blue-200 rounded hover:bg-blue-300 ml-1",onClick:()=>l.current?.click(),children:"ðŸ“‚ Buscar imagen"})]}):t.type==="text"?e.jsx("button",{type:"button",className:"px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 ml-1",onClick:s,children:"ðŸ”"}):null}const fe=te("flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",{variants:{orientation:{horizontal:"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none",vertical:"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none"}},defaultVariants:{orientation:"horizontal"}});function he({className:n,orientation:o,...t}){return e.jsx("div",{role:"group","data-slot":"button-group","data-orientation":o,className:ee(fe({orientation:o}),n),...t})}const R={seguimientos:"SEGUIMIENTO",procedimientos:"PROCEDIMIENTO",medicamentos:"MEDICAMENTO",anamnesis:"ANAMNESIS"},xe={create:{title:"REGISTRAR",btn:"Guardar",cls:"bg-blue-600 hover:bg-blue-700 text-white",icon:e.jsx(de,{className:"w-4 h-4"}),border:"border-l border-blue-500"},update:{title:"ACTUALIZAR",btn:"Actualizar",cls:"bg-green-600 hover:bg-green-700 text-white",icon:e.jsx(G,{className:"w-4 h-4"}),border:"border-l border-green-500"},delete:{title:"ELIMINAR",btn:"Eliminar",cls:"bg-red-600 hover:bg-red-700 text-white",icon:e.jsx(V,{className:"w-4 h-4"}),border:"border-l border-red-500",readonly:!0}},_=n=>n.endsWith("is")?n:n.replace(/s$/,""),P=n=>`id_historia_clinica_${_(n)}`,B=(n,o)=>o?`/historia_clinica_${_(n)}/${o}`:`/historia_clinica_${_(n)}/form`,be=(n,o)=>n.find(t=>t.key.startsWith("id_")||t.label.toLowerCase().includes(_(o)))?.value??null,je=n=>n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),L=n=>{if(!n||!/^\d{4}-\d{2}-\d{2}$/.test(n))return null;const[o,t,j]=n.split("-").map(Number);return new Date(o,t-1,j)},ge=n=>{if(!n)return"Sin fecha";const o=L(n);return o?o.toLocaleDateString("es-PE"):"Sin fecha"};function ye({view:n,formId:o,action:t="update"}){const j=t==="update",l=d.useMemo(()=>window.location.pathname.match(/\/update\/(\d+)/)?.[1]??o,[o]),[s,y]=d.useState({open:!1,tipo:null,reg:null,act:"update"}),[p,b]=d.useState({}),[i,a]=d.useState({}),[h,x]=d.useState({}),v=d.useRef({}),{post:N,put:I,delete:T,processing:C,errors:u,setData:E}=z({}),O=d.useCallback(()=>{fetch(`/api/historia/${l}/records`).then(r=>r.json()).then(x).catch(()=>{})},[l]);d.useEffect(O,[O]),d.useEffect(()=>{!s.open||!s.tipo||p[s.tipo]||fetch(`/api/historia/${s.tipo}/fields`).then(r=>r.json()).then(r=>b(f=>({...f,[s.tipo]:Object.entries(r).map(([c,m])=>[c,m.label??c,m.type??"text",m.options??null])})))},[s.open,s.tipo,p]),d.useEffect(()=>{if(!s.open||!s.tipo||!p[s.tipo])return;const r={};p[s.tipo].forEach(([c])=>r[c]=s.reg?.find(m=>m.key===c)?.value??"");const f=s.reg?be(s.reg,s.tipo):null;f&&(r[P(s.tipo)]=f),s.act==="create"&&(r.id_historia_clinica=l),a(r)},[s.open,s.tipo,s.reg,p,l]),d.useEffect(()=>E(i),[i,E]);const $=d.useCallback(r=>{if(r.preventDefault(),!s.tipo)return;const f=i[P(s.tipo)],m={onSuccess:()=>{y(g=>({...g,open:!1})),O()}};s.act==="create"?N(B(s.tipo),{data:i,...m}):s.act==="update"?I(B(s.tipo,f),{data:i,...m}):T(B(s.tipo,f),m)},[s,i,N,I,T,O]),k=(r,f,c)=>y({open:!0,tipo:r,reg:f,act:c}),M=()=>y({open:!1,tipo:null,reg:null,act:"update"}),D=d.useMemo(()=>{const r={};return Object.entries(h).forEach(([f,c])=>{c.forEach(m=>{const g=m.find(F=>F.key==="fecha")?.value??"Sin fecha";r[g]||(r[g]=[]),r[g].push({tipo:R[f],f:m,k:f})})}),Object.fromEntries(Object.entries(r).sort(([f],[c])=>{const m=L(f)?.getTime()??0;return(L(c)?.getTime()??0)-m}))},[h]),S=s.tipo?xe[s.act]:null,A=s.tipo?R[s.tipo]:"";return e.jsxs("div",{className:"flex flex-col gap-4",children:[j&&e.jsx(he,{className:"gap-1 flex flex-wrap",children:Object.keys(R).map(r=>e.jsx(w,{size:"sm",variant:"outline",className:"text-xs font-medium min-w-0 px-2",onClick:()=>k(r,null,"create"),children:je(R[r])},r))}),Object.entries(D).map(([r,f])=>e.jsxs("div",{className:"",children:[e.jsx("h3",{className:"font-semibold text-gray-600 dark:text-gray-400 mb-2",children:r==="Sin fecha"?r:ge(r)}),f.map((c,m)=>e.jsxs("div",{className:"border rounded-lg p-3 flex justify-between bg-muted/40 mb-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-purple-600 dark:text-purple-400",children:c.tipo}),c.f.filter(g=>!["id_","fecha","created_at","updated_at"].some(F=>g.key.startsWith(F)||g.key===F)).map((g,F)=>e.jsxs("p",{className:"text-sm",children:[g.label,": ",g.value??"-"]},F))]}),j&&e.jsxs("div",{className:"flex flex-col gap-1 ml-2",children:[e.jsx(w,{size:"icon",variant:"outline",onClick:()=>k(c.k,c.f,"update"),children:e.jsx(G,{className:"w-4 h-4"})}),e.jsx(w,{size:"icon",variant:"destructive",onClick:()=>k(c.k,c.f,"delete"),children:e.jsx(V,{className:"w-4 h-4"})})]})]},`${c.k}-${m}`))]},r)),e.jsx(ne,{open:s.open,onOpenChange:M,children:e.jsxs(re,{className:`max-w-lg p-6 ${S?.border||""}`,children:[S&&e.jsxs(e.Fragment,{children:[e.jsx(ae,{children:e.jsxs(le,{className:"flex items-center gap-2 text-lg font-bold",children:[S.title," ",A]})}),e.jsxs(ie,{className:"sr-only",children:["Formulario para ",S.title.toLowerCase()," ",A.toLowerCase(),"."]})]}),e.jsxs("form",{onSubmit:$,className:"space-y-3",children:[(p[s.tipo??""]??[]).filter(([r])=>r!=="id_historia_clinica").map(([r,f,c,m])=>e.jsx(U,{formFields:{[r]:{form:{key:r,label:f,type:c,options:m}}},data:i,setData:(g,F)=>a(q=>({...q,[g]:F})),errors:u,readonly:S?.readonly,hiddenFields:[],isMobile:!0,inputRefs:v,view:n},r)),e.jsx("div",{className:"flex justify-end",children:e.jsxs(w,{type:"submit",disabled:C,className:`${S?.cls} flex items-center gap-2`,children:[C?e.jsx(ce,{className:"w-4 h-4 animate-spin"}):S?.icon,S?.btn]})})]})]})})]})}const Ne=({form_data:n,formFields:o,action:t,custom_title:j,view:l,title:s,width_form:y="w-full",readonly:p=!1,toggleOptions:b,queryparams:i,apiConfig:a,debug:h=!1})=>{const{data:x,setData:v,post:N,put:I,delete:T,processing:C,errors:u,recentlySuccessful:E,reset:O}=z(n),$=d.useRef({}),k=K();ue({view:l,data:x,setData:v});const{title:M,description:D,cardBorderClass:S,readonly:A,handleSubmit:r,FooterButtons:f}=se(t,j,n,l,N,I,T,C,E,i,x,v,O),{hiddenFields:c,ToggleUI:m}=pe(b,v,x,l,t),g=me({data:x,setData:v,apiConfig:a,view:l}),F=oe(l);return e.jsxs(W,{breadcrumbs:[{title:F,href:l}],children:[e.jsx(H,{title:F}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 rounded-xl",children:[e.jsxs(J,{className:`${k?"w-full":y} border-2 ${S}`,children:[e.jsx(Z,{children:e.jsxs("div",{className:"flex flex-wrap items-start gap-x-4",children:[e.jsxs("div",{children:[e.jsxs(Q,{children:[M," ",F.toUpperCase()]}),e.jsx(X,{children:D})]}),m&&e.jsx("div",{className:"mt-1",children:e.jsx(m,{})})]})}),e.jsxs(Y,{children:[h&&e.jsxs(e.Fragment,{children:[console.log("ðŸ“‹ formFields:",o),console.log("ðŸ“¤ data actual:",x)]}),e.jsxs("form",{onSubmit:r,action:route(`${l}.form`,{id:n?.id,action:t}),method:"POST",className:"space-y-2",encType:"multipart/form-data",children:[e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(U,{formFields:o,data:x,setData:v,errors:u,readonly:p||A,hiddenFields:c,isMobile:k,inputRefs:$,view:l,apiConfig:a,FetchButton:g})}),f]})]})]}),t!=="create"&&e.jsx(ye,{view:l,action:t,formId:n?.[`id_${l}`],debug:h})]})]})};function Ge(n){return e.jsx(Ne,{...n})}export{Ge as default};
