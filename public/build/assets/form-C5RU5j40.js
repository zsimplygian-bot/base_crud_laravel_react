import{r as d,j as e,u as se,c as re,H as ie}from"./app-CTHJeX1L.js";import{u as le,A as ce}from"./app-layout-DZl7m3kS.js";import{C as de,a as ue,b as me,d as pe,e as fe}from"./card-DYZmxqLr.js";import{B as A,c as he,d as xe}from"./button-COEW_BXt.js";import{u as ge,F as be}from"./footer-buttons-C8o3mbC_.js";import{F as oe,g as je}from"./custom-titles-DXErslvE.js";import{D as ye,a as Ne,b as ve,c as Fe,e as ke}from"./dialog-DfzAKLNq.js";import{P as ne,I as Ee}from"./pencil-BMV9ZOWF.js";import{F as Se}from"./file-text-DP4hcopQ.js";import{T as ae}from"./trash-C0Ay4h-R.js";import{L as Y}from"./loader-circle-tU9d4Dv0.js";import{S as Ce}from"./trash-2-Bh3-ooNX.js";/* empty css            */import"./index-DnQ_TD2r.js";import"./sidebar_cita-BOOQZpyZ.js";import"./index-FE86NjM7.js";import"./index-CVASjcgI.js";import"./navigation-button-DBt9aaRd.js";import"./transition-DbJq38KG.js";import"./label-DmVFzi5d.js";import"./input-CsXN8Tsz.js";import"./field-combobox-CKr4JhNy.js";import"./input-error-BUIQjcrh.js";function Ie({view:a,data:n,setData:t}){const N=d.useRef(!1);d.useEffect(()=>{if(a!=="liquidacion")return;const u=parseFloat(n.valor??"");let o=parseFloat(n.porcentaje??"");parseInt(n.id_tipo_liquid)===1&&parseInt(n.nrorev)===1&&(o*=4);const v=o/100,h=parseFloat(n.tasamin??""),y=parseFloat(n.tasamax??""),l=parseFloat(n.igv??"");if(!(!isNaN(u)&&!isNaN(v))){t("porcenaplica",""),t("igvporcen",""),t("subtotal",""),t("total","");return}const b=u*v;t("porcenaplica",b.toFixed(2));const E=isNaN(l)?0:b/100*l;t("igvporcen",E.toFixed(2));const F=b+E;t("subtotal",F.toFixed(2));let j=F;isNaN(h)||(j=Math.max(j,h)),!isNaN(y)&&y>0&&(j=Math.min(j,y)),t("total",j.toFixed(2)),N.current=!0},[a,n.valor,n.porcentaje,n.igv,n.tasamin,n.tasamax,n.id_tipo_liquid,n.nrorev])}function we(a,n,t,N,u){if(!a?.values?.length)return{activeOption:"",hiddenFields:[],ToggleUI:()=>null};const{label:o,values:v,fields:h}=a,y=u==="info"||u==="delete",l=d.useCallback(()=>v.find(p=>(h[p]||[]).some(C=>t[C]!=null&&t[C]!==""))||v[0],[t,h,v]),[c,b]=d.useState(()=>l()),[E,F]=d.useState(!1),j=d.useCallback(p=>{if(N==="tasaliquid")return;const C=new Set(h[p]||[]);Object.values(h).flat().forEach(T=>{C.has(T)||n(T,"")})},[h,n,N]);d.useEffect(()=>{if(E)return;const p=l();p!==c&&(b(p),j(p))},[t,E,c,l,j]);const R=d.useCallback(p=>{p!==c&&(F(!0),b(p),j(p))},[c,j]),O=d.useMemo(()=>{const p=new Set(h[c]||[]);return Object.values(h).flat().filter(C=>!p.has(C))},[h,c]);return{activeOption:c,hiddenFields:O,ToggleUI:()=>e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[o,":"]}),v.map(p=>e.jsx(A,{type:"button",variant:c===p?"default":"outline",onClick:()=>R(p),disabled:y,children:p},p))]})}}function Te({data:a,setData:n,apiConfig:t,view:N}){if(!t)return null;const u=d.useRef(null),o=async()=>{const y=a[t.inputKey]?.trim();if(!y)return alert("El campo no puede estar vacÃ­o");try{const c=await(await fetch(`undefined/${t.endpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({[t.inputKey]:y})})).json();console.log(`[${N}] Respuesta API texto:`,c),Object.entries(t.fields).forEach(([b,E])=>n(b,c[E]??t.emptyValue))}catch(l){console.error(`[${N}]`,l),Object.keys(t.fields).forEach(c=>n(c,t.emptyValue))}},v=async y=>{if(!y)return;const l=new FormData;l.append("imagen",y);try{const b=await(await fetch(`undefined/${t.endpoint}`,{method:"POST",body:l})).json();console.log(`[${N}] Respuesta API imagen:`,b),Object.entries(t.fields).forEach(([E,F])=>n(E,b[F]??t.emptyValue))}catch(c){console.error(`[${N}]`,c),Object.keys(t.fields).forEach(b=>n(b,t.emptyValue))}};return({fieldKey:y})=>y!==t.inputKey?null:t.type==="file"?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",ref:u,className:"hidden",accept:"image/*",onChange:l=>{const c=l.target.files?.[0];c&&v(c)}}),e.jsx("button",{type:"button",className:"px-2 py-1 bg-blue-200 rounded hover:bg-blue-300 ml-1",onClick:()=>u.current?.click(),children:"ðŸ“‚ Buscar imagen"})]}):t.type==="text"?e.jsx("button",{type:"button",className:"px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 ml-1",onClick:o,children:"ðŸ”"}):null}const $e=xe("flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",{variants:{orientation:{horizontal:"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none",vertical:"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none"}},defaultVariants:{orientation:"horizontal"}});function Oe({className:a,orientation:n,...t}){return e.jsx("div",{role:"group","data-slot":"button-group","data-orientation":n,className:he($e({orientation:n}),a),...t})}const z={seguimientos:"SEGUIMIENTO",procedimientos:"PROCEDIMIENTO",medicamentos:"MEDICAMENTO",anamnesis:"ANAMNESIS"},_e={create:{title:"REGISTRAR",btn:"Guardar",cls:"bg-blue-600 hover:bg-blue-700 text-white",icon:e.jsx(Ce,{className:"w-4 h-4"}),border:"border-l border-blue-500"},update:{title:"ACTUALIZAR",btn:"Actualizar",cls:"bg-green-600 hover:bg-green-700 text-white",icon:e.jsx(ne,{className:"w-4 h-4"}),border:"border-l border-green-500"},delete:{title:"ELIMINAR",btn:"Eliminar",cls:"bg-red-600 hover:bg-red-700 text-white",icon:e.jsx(ae,{className:"w-4 h-4"}),border:"border-l border-red-500",readonly:!0}},G=a=>a.endsWith("is")?a:a.replace(/s$/,""),ee=a=>`id_historia_clinica_${G(a)}`,te=(a,n)=>n?`/historia_clinica_${G(a)}/${n}`:`/historia_clinica_${G(a)}/form`,Ae=(a,n)=>a.find(t=>t.key.startsWith("id_")||t.label.toLowerCase().includes(G(n)))?.value??null,Re=a=>a.charAt(0).toUpperCase()+a.slice(1).toLowerCase(),J=a=>{if(!a||!/^\d{4}-\d{2}-\d{2}$/.test(a))return null;const[n,t,N]=a.split("-").map(Number);return new Date(n,t-1,N)},Le=a=>{if(!a)return"Sin fecha";const n=J(a);return n?n.toLocaleDateString("es-PE"):"Sin fecha"};function De({view:a,formId:n,action:t="update"}){const N=t==="update",u=d.useMemo(()=>window.location.pathname.match(/\/update\/(\d+)/)?.[1]??n,[n]),[o,v]=d.useState({open:!1,tipo:null,reg:null,act:"update"}),[h,y]=d.useState({}),[l,c]=d.useState({}),[b,E]=d.useState({}),[F,j]=d.useState(!0),R=d.useRef({}),{post:O,put:L,delete:p,processing:C,errors:U,setData:T}=se({}),_=d.useCallback(()=>{j(!0),fetch(`/api/historia/${u}/records`).then(s=>s.json()).then(E).finally(()=>j(!1))},[u]);d.useEffect(_,[_]),d.useEffect(()=>{!o.open||!o.tipo||h[o.tipo]||fetch(`/api/historia/${o.tipo}/fields`).then(s=>s.json()).then(s=>y(f=>({...f,[o.tipo]:Object.entries(s).map(([r,i])=>[r,i.label??r,i.type??"text",i.options??null])})))},[o.open,o.tipo,h]),d.useEffect(()=>{if(!o.open||!o.tipo||!h[o.tipo])return;const s={};h[o.tipo].forEach(([r])=>s[r]=o.reg?.find(i=>i.key===r)?.value??"");const f=o.reg?Ae(o.reg,o.tipo):null;f&&(s[ee(o.tipo)]=f),o.act==="create"&&(s.id_historia_clinica=u),c(s)},[o.open,o.tipo,o.reg,h,u]),d.useEffect(()=>T(l),[l,T]);const B=d.useCallback(s=>{if(s.preventDefault(),!o.tipo)return;const f=l[ee(o.tipo)],r=Object.values(l).some(g=>g instanceof File),i=o.act==="create"?te(o.tipo):te(o.tipo,f),m=()=>{v(g=>({...g,open:!1})),_()};if(r){const g=new FormData,x=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content");x&&g.append("_token",x),o.act!=="create"&&g.append("_method","PUT"),Object.entries(l).forEach(([k,w])=>{w!=null&&g.append(k,w instanceof File?w:String(w))}),re.post(i,g,{forceFormData:!0,preserveScroll:!0,onSuccess:m});return}o.act==="create"?O(i,{data:l,onSuccess:m}):o.act==="update"?L(i,{data:l,onSuccess:m}):p(i,{onSuccess:m})},[o,l,O,L,p,_]),D=(s,f,r)=>v({open:!0,tipo:s,reg:f,act:r}),K=()=>v({open:!1,tipo:null,reg:null,act:"update"}),q=d.useMemo(()=>{const s={};return Object.entries(b).forEach(([f,r])=>{r.forEach(i=>{const m=i.find(g=>g.key==="fecha")?.value??"Sin fecha";s[m]||(s[m]=[]),s[m].push({tipo:z[f],f:i,k:f})})}),Object.fromEntries(Object.entries(s).sort(([f],[r])=>{const i=J(f)?.getTime()??0;return(J(r)?.getTime()??0)-i}))},[b]),I=o.tipo?_e[o.act]:null,M=o.tipo?z[o.tipo]:"",V=s=>{const f=["id","created_at","updated_at","fecha"],r=s.f.filter(x=>!f.some(k=>x.key.startsWith(k)||x.key===k));let i="Sin tÃ­tulo",m="text-purple-600 dark:text-purple-400",g="";if(s.k==="procedimientos"){const x=r.find(k=>k.key.toLowerCase().includes("nombre")||k.key.toLowerCase().includes("procedimiento")||k.label.toLowerCase().includes("procedimiento")||k.label.toLowerCase().includes("nombre"));i=x?String(x.value).toUpperCase().trim():"PROCEDIMIENTO",g=x?.key||"",m="text-blue-600 dark:text-blue-400"}else if(s.k==="medicamentos"){const x=r.find(k=>k.key.toLowerCase().includes("medicamento")||k.key.toLowerCase().includes("nombre")||k.label.toLowerCase().includes("medicamento")||k.label.toLowerCase().includes("nombre"));i=x?String(x.value).trim():"MEDICAMENTO",g=x?.key||"",m="text-green-600 dark:text-green-400"}else s.k==="anamnesis"?(i="ANAMNESIS",m="text-red-600 dark:text-red-400"):s.k==="seguimientos"&&(i="SEGUIMIENTO",m="text-gray-600 dark:text-gray-400");return{title:i,color:m,usedKey:g}},W=s=>({procedimientos:"historia_clinica_procedimiento",medicamentos:"historia_clinica_medicamento",anamnesis:"historia_clinica_anamnesis",seguimientos:"historia_clinica_seguimiento"})[s]||"historia_clinica";return e.jsxs("div",{className:"flex flex-col gap-4",children:[N&&e.jsx(Oe,{className:"gap-1 flex flex-wrap",children:Object.keys(z).map(s=>e.jsx(A,{size:"sm",variant:"outline",className:"text-xs font-medium min-w-0 px-2",onClick:()=>D(s,null,"create"),children:Re(z[s])},s))}),Object.entries(q).map(([s,f])=>e.jsxs("div",{className:"",children:[e.jsx("h3",{className:"font-semibold text-gray-600 dark:text-gray-400 mb-2",children:s==="Sin fecha"?s:Le(s)}),f.map((r,i)=>{const{title:m,color:g,usedKey:x}=V(r),w=r.f.find(S=>S.key==="archivo")?.value,Z=w&&typeof w=="string"&&w.trim()!=="",Q=W(r.k);let P=null,X=!1,H=!1;if(Z){const S=w.trim(),$=S.toLowerCase().split(".").pop()||"";["jpg","jpeg","png","gif","webp"].includes($)?(P=`/images/${Q}/${S}`,X=!0):$==="pdf"&&(P=`/pdf/${Q}/${S}`,H=!0),console.log(`[DEBUG] Tipo: ${r.k}, TÃ­tulo: ${m}, Archivo detectado: ${w}, URL generada: ${P}, Es imagen: ${X}, Es PDF: ${H}`)}else console.log(`[DEBUG] Tipo: ${r.k}, TÃ­tulo: ${m}, No se detectÃ³ archivo`);return e.jsx("div",{className:"border rounded-lg p-3 bg-muted/40 mb-3 shadow-sm",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`font-bold text-xl ${g}`,children:m}),r.f.filter(S=>!["id","created_at","updated_at","fecha","archivo"].some($=>S.key.startsWith($)||S.key===$)&&S.key!==x&&S.value!=null&&String(S.value).trim()!=="").map((S,$)=>e.jsxs("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:[e.jsxs("span",{className:"font-medium",children:[S.label,":"]})," ",S.value]},$))]}),N&&e.jsxs("div",{className:"flex flex-col gap-2 ml-4",children:[e.jsx(A,{size:"icon",variant:"outline",onClick:()=>D(r.k,r.f,"update"),children:e.jsx(ne,{className:"w-4 h-4"})}),Z&&P&&e.jsx(A,{size:"icon",variant:"outline",className:"border-blue-500 text-blue-600 hover:bg-blue-50",asChild:!0,children:e.jsx("a",{href:P,target:"_blank",rel:"noopener noreferrer",children:H?e.jsx(Se,{className:"w-4 h-4"}):e.jsx(Ee,{className:"w-4 h-4"})})}),e.jsx(A,{size:"icon",variant:"destructive",onClick:()=>D(r.k,r.f,"delete"),children:e.jsx(ae,{className:"w-4 h-4"})})]})]})},`${r.k}-${i}`)})]},s)),F&&e.jsx("div",{className:"w-full flex justify-center py-4",children:e.jsx(Y,{className:"w-6 h-6 animate-spin text-gray-500"})}),e.jsx(ye,{open:o.open,onOpenChange:K,children:e.jsxs(Ne,{className:`max-w-lg p-6 ${I?.border||""}`,children:[I&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{children:e.jsxs(Fe,{className:"flex items-center gap-2 text-lg font-bold",children:[I.title," ",M]})}),e.jsxs(ke,{className:"sr-only",children:["Formulario para ",I.title.toLowerCase()," ",M.toLowerCase(),"."]})]}),e.jsxs("form",{onSubmit:B,className:"space-y-3",children:[(h[o.tipo??""]??[]).filter(([s])=>s!=="id_historia_clinica").map(([s,f,r,i])=>e.jsx(oe,{formFields:{[s]:{form:{key:s,label:f,type:r,options:i}}},data:l,setData:(m,g)=>c(x=>({...x,[m]:g})),errors:U,readonly:I?.readonly,hiddenFields:[],isMobile:!0,inputRefs:R,view:a},s)),e.jsx("div",{className:"flex justify-end",children:e.jsxs(A,{type:"submit",disabled:C,className:`${I?.cls} flex items-center gap-2`,children:[C?e.jsx(Y,{className:"w-4 h-4 animate-spin"}):I?.icon,I?.btn]})})]})]})})]})}const Me=({form_data:a,formFields:n,action:t,custom_title:N,view:u,title:o,width_form:v="w-full",readonly:h=!1,toggleOptions:y,queryparams:l,apiConfig:c,debug:b=!1})=>{const E=d.useMemo(()=>({...a,backto:localStorage.getItem("lastPage")??null}),[a]),{data:F,setData:j,post:R,put:O,delete:L,processing:p,errors:C,recentlySuccessful:U,reset:T}=se(E),_=d.useRef({}),B=le();Ie({view:u,data:F,setData:j});const{title:D,description:K,cardBorderClass:q,readonly:I,handleSubmit:M,config:V,type:W,queryString:s,recentlySuccessful:f,processing:r}=ge(t,N,E,u,R,O,L,p,U,l,F,j,T),{hiddenFields:i,ToggleUI:m}=we(y,j,F,u,t),g=Te({data:F,setData:j,apiConfig:c,view:u}),x=je(u);return e.jsxs(ce,{breadcrumbs:[{title:x,href:u}],children:[e.jsx(ie,{title:x}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 rounded-xl",children:[e.jsxs(de,{className:`${B?"w-full":v} border-2 ${q}`,children:[e.jsx(ue,{children:e.jsxs("div",{className:"flex flex-wrap items-start gap-x-4",children:[e.jsxs("div",{children:[e.jsxs(me,{children:[D," ",x.toUpperCase()]}),e.jsx(pe,{children:K})]}),m&&e.jsx("div",{className:"mt-1",children:e.jsx(m,{})})]})}),e.jsxs(fe,{children:[b&&e.jsxs(e.Fragment,{children:[console.log("ðŸ“‹ formFields:",n),console.log("ðŸ“¤ data actual:",F)]}),e.jsxs("form",{onSubmit:M,method:"POST",className:"space-y-2",encType:"multipart/form-data",children:[e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(oe,{formFields:n,data:F,setData:j,errors:C,readonly:h||I,hiddenFields:i,isMobile:B,inputRefs:_,view:u,apiConfig:c,FetchButton:g})}),e.jsx(be,{view:u,queryString:s,config:V,type:W,handleSubmit:M,recentlySuccessful:f,processing:r})]})]})]}),t!=="create"&&e.jsx(De,{view:u,action:t,formId:a?.[`id_${u}`],debug:b})]})]})};function ct(a){return e.jsx(Me,{...a})}export{ct as default};
