import{r as c,j as e,u as z,H}from"./app-dZR7WKXN.js";import{D as K,k as W,l as J,m as Z,n as Q,A as X}from"./app-layout-C__KuJaw.js";import{C as Y,a as ee,b as te,d as se,e as ne}from"./card-WcXD5-6a.js";import{u as oe}from"./sidebar_cita-uHVk6ZXw.js";import{B as w,c as re,d as ae}from"./button-Bk1jZI2j.js";import{u as le}from"./use-form-action-B_5rVEQt.js";import{F as U}from"./form-fields-CtMc-bxB.js";import{P as G}from"./pencil-DOcdAVoM.js";import{T as V}from"./trash-DPuOszVz.js";import{L as ie}from"./loader-circle-DbYjTznt.js";import{S as ce}from"./trash-2-0OnNuzWh.js";/* empty css            */import"./index-FnpOlrhN.js";import"./index-luMnXO-k.js";import"./check-CdgHPWxF.js";import"./index-CVASjcgI.js";import"./transition-B5RTzjfA.js";import"./label-OoRXGgjQ.js";import"./input-CuyVVpBI.js";import"./field-combobox-BzRC6DSm.js";import"./input-error-BQTi04rW.js";function de({view:o,data:n,setData:t}){const j=c.useRef(!1);c.useEffect(()=>{if(o!=="liquidacion")return;const d=parseFloat(n.valor??"");let s=parseFloat(n.porcentaje??"");parseInt(n.id_tipo_liquid)===1&&parseInt(n.nrorev)===1&&(s*=4);const y=s/100,p=parseFloat(n.tasamin??""),b=parseFloat(n.tasamax??""),l=parseFloat(n.igv??"");if(!(!isNaN(d)&&!isNaN(y))){t("porcenaplica",""),t("igvporcen",""),t("subtotal",""),t("total","");return}const h=d*y;t("porcenaplica",h.toFixed(2));const x=isNaN(l)?0:h/100*l;t("igvporcen",x.toFixed(2));const v=h+x;t("subtotal",v.toFixed(2));let N=v;isNaN(p)||(N=Math.max(N,p)),!isNaN(b)&&b>0&&(N=Math.min(N,b)),t("total",N.toFixed(2)),j.current=!0},[o,n.valor,n.porcentaje,n.igv,n.tasamin,n.tasamax,n.id_tipo_liquid,n.nrorev])}function ue(o,n,t,j,d){if(!o?.values?.length)return{activeOption:"",hiddenFields:[],ToggleUI:()=>null};const{label:s,values:y,fields:p}=o,b=d==="info"||d==="delete",l=c.useCallback(()=>y.find(u=>(p[u]||[]).some(F=>t[F]!=null&&t[F]!==""))||y[0],[t,p,y]),[a,h]=c.useState(()=>l()),[x,v]=c.useState(!1),N=c.useCallback(u=>{if(j==="tasaliquid")return;const F=new Set(p[u]||[]);Object.values(p).flat().forEach($=>{F.has($)||n($,"")})},[p,n,j]);c.useEffect(()=>{if(x)return;const u=l();u!==a&&(h(u),N(u))},[t,x,a,l,N]);const I=c.useCallback(u=>{u!==a&&(v(!0),h(u),N(u))},[a,N]),k=c.useMemo(()=>{const u=new Set(p[a]||[]);return Object.values(p).flat().filter(F=>!u.has(F))},[p,a]);return{activeOption:a,hiddenFields:k,ToggleUI:()=>e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium",children:[s,":"]}),y.map(u=>e.jsx(w,{type:"button",variant:a===u?"default":"outline",onClick:()=>I(u),disabled:b,children:u},u))]})}}function pe({data:o,setData:n,apiConfig:t,view:j}){if(!t)return null;const d=c.useRef(null),s=async()=>{const b=o[t.inputKey]?.trim();if(!b)return alert("El campo no puede estar vacÃ­o");try{const a=await(await fetch(`undefined/${t.endpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({[t.inputKey]:b})})).json();console.log(`[${j}] Respuesta API texto:`,a),Object.entries(t.fields).forEach(([h,x])=>n(h,a[x]??t.emptyValue))}catch(l){console.error(`[${j}]`,l),Object.keys(t.fields).forEach(a=>n(a,t.emptyValue))}},y=async b=>{if(!b)return;const l=new FormData;l.append("imagen",b);try{const h=await(await fetch(`undefined/${t.endpoint}`,{method:"POST",body:l})).json();console.log(`[${j}] Respuesta API imagen:`,h),Object.entries(t.fields).forEach(([x,v])=>n(x,h[v]??t.emptyValue))}catch(a){console.error(`[${j}]`,a),Object.keys(t.fields).forEach(h=>n(h,t.emptyValue))}};return({fieldKey:b})=>b!==t.inputKey?null:t.type==="file"?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"file",ref:d,className:"hidden",accept:"image/*",onChange:l=>{const a=l.target.files?.[0];a&&y(a)}}),e.jsx("button",{type:"button",className:"px-2 py-1 bg-blue-200 rounded hover:bg-blue-300 ml-1",onClick:()=>d.current?.click(),children:"ðŸ“‚ Buscar imagen"})]}):t.type==="text"?e.jsx("button",{type:"button",className:"px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 ml-1",onClick:s,children:"ðŸ”"}):null}const me=ae("flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",{variants:{orientation:{horizontal:"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none",vertical:"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none"}},defaultVariants:{orientation:"horizontal"}});function fe({className:o,orientation:n,...t}){return e.jsx("div",{role:"group","data-slot":"button-group","data-orientation":n,className:re(me({orientation:n}),o),...t})}const R={seguimientos:"SEGUIMIENTO",procedimientos:"PROCEDIMIENTO",medicamentos:"MEDICAMENTO",anamnesis:"ANAMNESIS"},he={create:{title:"REGISTRAR",btn:"Guardar",cls:"bg-blue-600 hover:bg-blue-700 text-white",icon:e.jsx(ce,{className:"w-4 h-4"}),border:"border-l border-blue-500"},update:{title:"ACTUALIZAR",btn:"Actualizar",cls:"bg-green-600 hover:bg-green-700 text-white",icon:e.jsx(G,{className:"w-4 h-4"}),border:"border-l border-green-500"},delete:{title:"ELIMINAR",btn:"Eliminar",cls:"bg-red-600 hover:bg-red-700 text-white",icon:e.jsx(V,{className:"w-4 h-4"}),border:"border-l border-red-500",readonly:!0}},_=o=>o.endsWith("is")?o:o.replace(/s$/,""),P=o=>`id_historia_clinica_${_(o)}`,B=(o,n)=>n?`/historia_clinica_${_(o)}/${n}`:`/historia_clinica_${_(o)}/form`,xe=(o,n)=>o.find(t=>t.key.startsWith("id_")||t.label.toLowerCase().includes(_(n)))?.value??null,be=o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase(),L=o=>{if(!o||!/^\d{4}-\d{2}-\d{2}$/.test(o))return null;const[n,t,j]=o.split("-").map(Number);return new Date(n,t-1,j)},je=o=>{if(!o)return"Sin fecha";const n=L(o);return n?n.toLocaleDateString("es-PE"):"Sin fecha"};function ge({view:o,formId:n,action:t="update"}){const j=t==="update",d=c.useMemo(()=>window.location.pathname.match(/\/update\/(\d+)/)?.[1]??n,[n]),[s,y]=c.useState({open:!1,tipo:null,reg:null,act:"update"}),[p,b]=c.useState({}),[l,a]=c.useState({}),[h,x]=c.useState({}),v=c.useRef({}),{post:N,put:I,delete:k,processing:C,errors:u,setData:F}=z({}),O=c.useCallback(()=>{fetch(`/api/historia/${d}/records`).then(r=>r.json()).then(x).catch(()=>{})},[d]);c.useEffect(O,[O]),c.useEffect(()=>{!s.open||!s.tipo||p[s.tipo]||fetch(`/api/historia/${s.tipo}/fields`).then(r=>r.json()).then(r=>b(f=>({...f,[s.tipo]:Object.entries(r).map(([i,m])=>[i,m.label??i,m.type??"text",m.options??null])})))},[s.open,s.tipo,p]),c.useEffect(()=>{if(!s.open||!s.tipo||!p[s.tipo])return;const r={};p[s.tipo].forEach(([i])=>r[i]=s.reg?.find(m=>m.key===i)?.value??"");const f=s.reg?xe(s.reg,s.tipo):null;f&&(r[P(s.tipo)]=f),s.act==="create"&&(r.id_historia_clinica=d),a(r)},[s.open,s.tipo,s.reg,p,d]),c.useEffect(()=>F(l),[l,F]);const $=c.useCallback(r=>{if(r.preventDefault(),!s.tipo)return;const f=l[P(s.tipo)],m={onSuccess:()=>{y(g=>({...g,open:!1})),O()}};s.act==="create"?N(B(s.tipo),{data:l,...m}):s.act==="update"?I(B(s.tipo,f),{data:l,...m}):k(B(s.tipo,f),m)},[s,l,N,I,k,O]),T=(r,f,i)=>y({open:!0,tipo:r,reg:f,act:i}),M=()=>y({open:!1,tipo:null,reg:null,act:"update"}),D=c.useMemo(()=>{const r={};return Object.entries(h).forEach(([f,i])=>{i.forEach(m=>{const g=m.find(S=>S.key==="fecha")?.value??"Sin fecha";r[g]||(r[g]=[]),r[g].push({tipo:R[f],f:m,k:f})})}),Object.fromEntries(Object.entries(r).sort(([f],[i])=>{const m=L(f)?.getTime()??0;return(L(i)?.getTime()??0)-m}))},[h]),E=s.tipo?he[s.act]:null,A=s.tipo?R[s.tipo]:"";return e.jsxs("div",{className:"flex flex-col gap-4",children:[j&&e.jsx(fe,{className:"gap-1 flex flex-wrap",children:Object.keys(R).map(r=>e.jsx(w,{size:"sm",variant:"outline",className:"text-xs font-medium min-w-0 px-2",onClick:()=>T(r,null,"create"),children:be(R[r])},r))}),Object.entries(D).map(([r,f])=>e.jsxs("div",{className:"",children:[e.jsx("h3",{className:"font-semibold text-gray-600 dark:text-gray-400 mb-2",children:r==="Sin fecha"?r:je(r)}),f.map((i,m)=>e.jsxs("div",{className:"border rounded-lg p-3 flex justify-between bg-muted/40 mb-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-purple-600 dark:text-purple-400",children:i.tipo}),i.f.filter(g=>!["id_","fecha","created_at","updated_at"].some(S=>g.key.startsWith(S)||g.key===S)).map((g,S)=>e.jsxs("p",{className:"text-sm",children:[g.label,": ",g.value??"-"]},S))]}),j&&e.jsxs("div",{className:"flex flex-col gap-1 ml-2",children:[e.jsx(w,{size:"icon",variant:"outline",onClick:()=>T(i.k,i.f,"update"),children:e.jsx(G,{className:"w-4 h-4"})}),e.jsx(w,{size:"icon",variant:"destructive",onClick:()=>T(i.k,i.f,"delete"),children:e.jsx(V,{className:"w-4 h-4"})})]})]},`${i.k}-${m}`))]},r)),e.jsx(K,{open:s.open,onOpenChange:M,children:e.jsxs(W,{className:`max-w-lg p-6 ${E?.border||""}`,children:[E&&e.jsxs(e.Fragment,{children:[e.jsx(J,{children:e.jsxs(Z,{className:"flex items-center gap-2 text-lg font-bold",children:[E.title," ",A]})}),e.jsxs(Q,{className:"sr-only",children:["Formulario para ",E.title.toLowerCase()," ",A.toLowerCase(),"."]})]}),e.jsxs("form",{onSubmit:$,className:"space-y-3",children:[(p[s.tipo??""]??[]).filter(([r])=>r!=="id_historia_clinica").map(([r,f,i,m])=>e.jsx(U,{formFields:{[r]:{form:{key:r,label:f,type:i,options:m}}},data:l,setData:(g,S)=>a(q=>({...q,[g]:S})),errors:u,readonly:E?.readonly,hiddenFields:[],isMobile:!0,inputRefs:v,view:o},r)),e.jsx("div",{className:"flex justify-end",children:e.jsxs(w,{type:"submit",disabled:C,className:`${E?.cls} flex items-center gap-2`,children:[C?e.jsx(ie,{className:"w-4 h-4 animate-spin"}):E?.icon,E?.btn]})})]})]})})]})}const ye=({form_data:o,formFields:n,action:t,custom_title:j,view:d,title:s,width_form:y="w-full",readonly:p=!1,toggleOptions:b,queryparams:l,apiConfig:a,debug:h=!1})=>{const{data:x,setData:v,post:N,put:I,delete:k,processing:C,errors:u,recentlySuccessful:F,reset:O}=z(o),$=c.useRef({}),T=oe();de({view:d,data:x,setData:v});const{title:M,description:D,cardBorderClass:E,readonly:A,handleSubmit:r,FooterButtons:f}=le(t,j,o,d,N,I,k,C,F,l,x,v,O),{hiddenFields:i,ToggleUI:m}=ue(b,v,x,d,t),g=pe({data:x,setData:v,apiConfig:a,view:d});return e.jsxs(X,{breadcrumbs:[{title:s,href:d}],children:[e.jsx(H,{title:s}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 rounded-xl",children:[e.jsxs(Y,{className:`${T?"w-full":y} border-2 ${E}`,children:[e.jsx(ee,{children:e.jsxs("div",{className:"flex flex-wrap items-start gap-x-4",children:[e.jsxs("div",{children:[e.jsx(te,{children:M}),e.jsx(se,{children:D})]}),m&&e.jsx("div",{className:"mt-1",children:e.jsx(m,{})})]})}),e.jsxs(ne,{children:[h&&e.jsxs(e.Fragment,{children:[console.log("ðŸ“‹ formFields:",n),console.log("ðŸ“¤ data actual:",x)]}),e.jsxs("form",{onSubmit:r,action:route(`${d}.form`,{id:o?.id,action:t}),method:"POST",className:"space-y-2",encType:"multipart/form-data",children:[e.jsx("div",{className:"flex flex-wrap gap-4",children:e.jsx(U,{formFields:n,data:x,setData:v,errors:u,readonly:p||A,hiddenFields:i,isMobile:T,inputRefs:$,view:d,apiConfig:a,FetchButton:g})}),f]})]})]}),t!=="create"&&e.jsx(ge,{view:d,action:t,formId:o?.[`id_${d}`],debug:h})]})]})};function Ue(o){return e.jsx(ye,{...o})}export{Ue as default};
